<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de D√©bogage du Status Loader</title>
    <style>
        /* --- VARIABLES CSS (Placeholders pour la compilation) --- */
        :root {
            --bleu-trmdvsr-pur: #007bff;
            --bleu-trmdvsr-moyen: #0056b3;
            --bleu-trmdvsr-clair: #64b5f6;
            --blanc-trmdvsr: #ffffff;
            --gris-trmdvsr-clair: #f0f0f0;
            --rouge-trmdvsr-clair: #e57373;
            --vert-trmdvsr-clair: #81c784;
            --graisse-h2: bold;
            --largeur-loader: 150px;
            --espacement-court: 10px;
            --taille-sstexte: 16px;
            --taille-label: 14px;
        }

        /* --- VOS CSS INT√âGR√âS --- */
        .status-layer {
            display: none; /* Remplac√© par flex au runtime */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            width: auto;
            height: auto;
            margin: 0px;
            padding: 0px;
        }
        .status-layer.attached {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 1px dotted green;
        }
        .status-layer.attached.fullBlue {
            background-color: var(--bleu-trmdvsr-pur);
            opacity: 1;
        }
        .status-layer.attached.lightWhite {
            background-color: var(--blanc-trmdvsr);
            opacity: 0.5;
        }
        .status-box {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            width: var(--largeur-loader);
            aspect-ratio: 1 / 1;
            margin: 0px;
            padding: 0px;
        }
        .status-box .spinner-image {
            position: absolute;
            width: 100%;
            aspect-ratio: 1 / 1;
            margin: 0px;
            padding: 0px;
        }
        .status-box .spinner {
            position: absolute;
            width: 140%;
            aspect-ratio: 1 / 1;
            border: calc(var(--taille-sstexte) / 5) solid var(--bleu-trmdvsr-moyen);
            border-top: calc(var(--taille-sstexte) / 4) solid var(--bleu-trmdvsr-clair);
            border-radius: 50%;
            animation: spin 0.4s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-quo {
            width: auto;
            height: auto;
            padding-top: var(--espacement-court);
            border: 1px solid purple;
        }
        .status-layer .status-message {
            visibility: 1;
            opacity: 1;
            display: flex;
            width: 100%;
            /*
            * NOTE DE D√âBOGAGE:
            * height: 100% est DANGEREUX si le parent (status-quo) est height: auto;
            * Mettre height: auto ou min-height: 1em pour assurer l'affichage.
            */
            height: auto; /* Chang√© pour DEBOGAGE */
            min-height: 1.5em; /* Ajout√© pour DEBOGAGE */
            margin-top: calc(var(--largeur-loader) * 0.2);
            text-align: center;
            color: white;
            border: 1px solid black;
        }
        /* Classes de type de message */
        .status-layer .status-message.info    { color: var(--gris-trmdvsr-clair); }
        .status-layer .status-message.loading { color: var(--bleu-trmdvsr-clair); font-style: italic; }
        .status-layer .status-message.success { color: var(--vert-trmdvsr-clair); }
        .status-layer .status-message.error   { color: var(--rouge-trmdvsr-clair); font-weight: var(--graisse-h2); }
        .status-layer .status-message.warn    { color: orange; font-weight: var(--graisse-h2); }
        .status-layer .status-message.debug   { color: purple; font-weight: var(--graisse-h2); }

        /* Classes d'animation (√† compl√©ter si n√©cessaire) */
        .logo-loading { animation: loading 1s infinite; }
        @keyframes loading { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }


        .progress-container {
            display: flex;
            width: 100%;
            height: 0.75rem;
            margin-top: var(--espacement-court);
            border-radius: 0;
        }
        .progress-bar {
            display: flex;
            height: 5px;
        }
        .progress-text {
            display: flex;
            width: 100%;
            margin-top: 1rem;
            font-size: calc(var(--taille-label) * 0.66);
            justify-content: center;
        }
        .progress-container.fullBlue { background-color: var(--bleu-trmdvsr-moyen); }
        .progress-bar.fullBlue { background-color: var(--bleu-trmdvsr-clair); }
        .progress-text.fullBlue { color: var(--bleu-trmdvsr-clair); }
        .loading-target { position: relative; } /* Classe pour le conteneur cible */

        body {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #333;
        }
    </style>
</head>
<body>

    <!-- VOTRE STRUCTURE HTML -->
    <div id="status-module" class="status-layer">
        <div class="status-box">
            <div class="spinner"></div>
            <img class="spinner-image" src="https://placehold.co/100x100/007bff/ffffff?text=LOGO" alt="Logo de chargement"/>
        </div>
        <div class="status-quo">
            <span class="status-message trmdvsr-sstexte"></span>
            <div class="progress-container">
                <div class="progress-bar"></div>
                <p class="progress-text trmdvsr-label">00%</p>
            </div>
        </div>
    </div>
    
    <!-- Zone de test pour l'attachement -->
    <div id="test-container" style="width: 300px; height: 300px; border: 2px dashed red;">
        Zone de Conteneur Cible (Loader sera attach√© ici)
    </div>

    <script>
        // --- VARIABLES GLOBALES SIMUL√âES ---
        const DATE = new Date().toLocaleTimeString();
        const conteneurBODY = document.body;
        const isInit = { updateStatus: false };
        const loader = {
            logoURLs: {
                white: "https://placehold.co/100x100/ffffff/000000?text=WHITE",
                blue: "https://placehold.co/100x100/007bff/ffffff?text=BLUE"
            },
            element: null,
            animImgElmnt: null,
            animSpnElmnt: null,
            statusMessage: null,
            progressContainerElmnt: null,
            progressBarElmnt: null,
            progressTextElmnt: null,
        };

        // --- FONCTION MANQUANTE : INITIALISATION DES R√âF√âRENCES DOM ---
        function initUpdateStatusDOM() {
            console.log("-> initUpdateStatusDOM: Initialisation des r√©f√©rences DOM...");

            // 1. R√©f√©rence au conteneur principal
            loader.element = document.getElementById('status-module');

            // 2. R√©f√©rences aux enfants pour les mises √† jour
            if (loader.element) {
                // S'assurer que le s√©lecteur pointe EXACTEMENT vers le SPAN
                loader.statusMessage = loader.element.querySelector('.status-message');
                
                // R√©cup√©ration des autres √©l√©ments
                loader.animImgElmnt = loader.element.querySelector('.spinner-image');
                loader.animSpnElmnt = loader.element.querySelector('.spinner');
                loader.progressContainerElmnt = loader.element.querySelector('.progress-container');
                loader.progressBarElmnt = loader.element.querySelector('.progress-bar');
                loader.progressTextElmnt = loader.element.querySelector('.progress-text');

                // V√âRIFICATION CRITIQUE POUR LE D√âBOGAGE
                if (!loader.statusMessage) {
                    console.error("√âchec: loader.statusMessage est null. V√©rifiez la classe '.status-message' dans le HTML.");
                } else {
                    console.log("Succ√®s: loader.statusMessage est correctement r√©f√©renc√©.");
                }
            } else {
                console.error("√âchec: Element #status-module non trouv√©.");
            }
        }

        // --- VOTRE FONCTION UPDATESTATUS R√âVIS√âE ---
        // J'ai mis 'info' entre guillemets car vous l'utilisez comme variable, pas comme type de variable.
        function updateStatus( { trgtElmnt=null, imgType=null, type='info', isLdng=false, msg=null, current=null, total=null} ) {
            console.log(`updateStatus [param]trgtElmnt:${trgtElmnt} & imgType:${imgType} & type:${type} & msg:${msg} & isLdng:${isLdng} & current:${current} & total:${total}`)
            
            // ---------------------------------------------------------------------------------------- // RESET
            if (!loader.element) { console.error( `Initialisez avant d'appeler (loader.element manquant).` ); return; }
            loader.element.className = 'status-layer'; // Cleane de toutes classes
            
            if (!loader.animImgElmnt) { console.error( `loader.animImgElmnt manquant.` ); return; }
            loader.animImgElmnt.className = 'spinner-image'; // Cleane de toutes classes
            if (!loader.progressContainerElmnt) { console.error( `loader.progressContainerElmnt manquant.` ); return; }
            loader.progressContainerElmnt.className = 'progress-container';
            if (!loader.progressBarElmnt) { console.error( `loader.progressBarElmnt manquant.` ); return; }
            loader.progressBarElmnt.className = 'progress-bar';
            if (!loader.progressTextElmnt) { console.error( `loader.progressTextElmnt manquant.` ); return; }
            loader.progressTextElmnt.className = 'progress-text trmdvsr-label'; ¬† ¬†
            
            const className = 'loading-target'; // Set classe position relative
            const elmntsWithClass = document.querySelectorAll(`.${className}`); // S√©lect TOUS les √©l√©ments avec cette classe
            if (elmntsWithClass.length <= 0) {
                console.log(`elmntsWithClass semble vide.`);
            } else {
                elmntsWithClass.forEach( e => { e.classList.remove(className); } ); // Supp la classe de chaque √©l√©ment
                console.log(`${className} a √©t√© supprim√©e de ${elmntsWithClass.length} √©l√©ment(s).`);
            }
            
            loader.element.style.display = isLdng ? 'flex' : 'none'; // Affiche
            if (!isLdng) return;
            
            // ---------------------------------------------------------------------------------------- // CONTENEUR
            // Utilisation d'un s√©lecteur CSS si trgtElmnt est une cha√Æne, sinon conteneurBODY
            trgtElmnt = (typeof trgtElmnt === 'string' ? document.querySelector(trgtElmnt) : trgtElmnt) ?? conteneurBODY;
            trgtElmnt.classList.add(className); 
            
            // ---------------------------------------------------------------------------------------- // OBJET 
            let refCSS = (imgType === 'white') ? 'lightWhite' : 'fullBlue'; // D√©finit CSS
            if (loader.element.parentNode !== trgtElmnt) trgtElmnt.appendChild(loader.element); // Attache DOM => parent diff√©rent
            loader.element.classList.add('attached', refCSS); // Attache CSS
            loader.progressContainerElmnt.classList.add(refCSS); // Attache CSS
            loader.progressBarElmnt.classList.add(refCSS); // Attache CSS
            loader.progressTextElmnt.classList.add(refCSS); // Attache CSS

            // ---------------------------------------------------------------------------------------- // SPINNER ANIM√â
            if (loader.animSpnElmnt) loader.animSpnElmnt.style.display = 'flex'; 
            if (loader.animImgElmnt && imgType) { // loader.element ANIM√â
                const url = loader.logoURLs[imgType];
                if(url) loader.animImgElmnt.src = url;
                else console.warn(`Type de logo inconnu ou URL non trouv√©e pour ${imgType}.`);
                // Note: la classe logo-${type} est ajout√©e, assurez-vous qu'elle d√©clenche une animation valide.
                loader.animImgElmnt.classList.add( `logo-${type}` ); // info / loading / error
            }

            // ---------------------------------------------------------------------------------------- // MESSAGE
            if (loader.statusMessage && msg !== null) {
                // V√âRIFICATION D'EXISTENCE
                console.log(`R√©f√©rence statusMessage existante: ${!!loader.statusMessage}`);
                
                // 1. MISE √Ä JOUR CRITIQUE DU TEXTE
                loader.statusMessage.textContent = msg; 
                console.log(`textContent APRES assignation: ${loader.statusMessage.textContent}`);

                // 2. CORRECTION/NETTOYAGE DE CLASSE : 
                // Pour √©viter d'effacer la classe 'trmdvsr-sstexte' n√©cessaire pour les styles.
                // Au lieu de 'className = ...', on s'assure que les classes de base sont l√†.
                loader.statusMessage.classList.add('trmdvsr-sstexte', 'status-message');
                
                // On efface l'ancienne classe de type et on ajoute la nouvelle.
                const statusTypes = ['info', 'loading', 'success', 'error', 'warn', 'debug'];
                statusTypes.forEach(t => {
                    if (t !== type) loader.statusMessage.classList.remove(t);
                });
                loader.statusMessage.classList.add(type);
            }

            // ---------------------------------------------------------------------------------------- // PROGRESS BAR
            if (current && total && loader.progressContainerElmnt && loader.progressBarElmnt && loader.progressTextElmnt) {
                loader.progressContainerElmnt.style.display = (total > 0) ? 'flex' : 'none'; // Affiche barre progression si en charge et total sup √† z√©ro
                if (total > 0 && current <= total) {
                    const percent = Math.round((current / total) * 100);
                    loader.progressBarElmnt.style.width = `${percent}%`;
                    loader.progressTextElmnt.textContent = `${percent}% (${current}/${total} images enregistr√©es)`;
                } else {
                    loader.progressBarElmnt.style.width = '0%';
                    loader.progressTextElmnt.textContent = '0% (0/0 images enregistr√©es)';
                }
            }
            console.log('updateStatus OK');
        };


        // --- D√âMARRAGE DE L'APPLICATION ET TEST AUTOMATIQUE ---
        function initAPP() {
            console.log (`üöÄ=====üöÄ ${DATE} üöÄ=====üöÄ\n\nüèÅ=====üèÅ C'est parti.üèÅ=====üèÅ` );
            try {
                if (!isInit.updateStatus) {
                    initUpdateStatusDOM(); // Initialise le composant de loading
                    isInit.updateStatus = true; // üèÅ Active le flag
                }
                
                // TEST 1: Affichage initial du message de chargement (cible #test-container)
                console.log("\n--- TEST 1 : Message de chargement ---");
                updateStatus( { 
                    trgtElmnt: '#test-container', 
                    imgType: 'blue', 
                    type: 'loading', 
                    isLdng: true, 
                    msg: `R√©veil de l'IA...`
                } );

                // TEST 2: Mise √† jour de la progression et changement de type de message
                setTimeout(() => {
                    console.log("\n--- TEST 2 : Mise √† jour de la progression ---");
                    updateStatus( { 
                        trgtElmnt: '#test-container', 
                        imgType: 'blue', 
                        type: 'loading', 
                        isLdng: true, 
                        msg: `Chargement des assets (1/10)...`, 
                        current: 1, 
                        total: 10
                    } );
                }, 2000);

                 // TEST 3: Succ√®s
                setTimeout(() => {
                    console.log("\n--- TEST 3 : Message de Succ√®s et Arr√™t ---");
                    updateStatus( { 
                        imgType: 'white', 
                        type: 'success', 
                        isLdng: false, 
                        msg: `Op√©ration r√©ussie !`
                    } );
                }, 4000);


            } catch(e) {
                console.error("Erreur dans initAPP:", e);
            }
        }

        // D√©marrage
        window.onload = initAPP;

    </script>

</body>
</html>